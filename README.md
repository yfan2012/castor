# castor
Toolkit for analyzing transcripts in Nanostring CosMx data.

![castor logo](castor_logo.png "castor logo")

The code in this repo was developed to explore potentially duplicated transcripts reported in the flat files of Nanostring CosMx data. From carefully inspecting the transcript tables, it can be observed that there are some incidences of two identical probes reported at adjacent pixels in local x-y space, and often on consecutive z planes. One potential explanation is a bleed-through artefact between z planes. To further explore and understand the extent of this phenomenon, the tools here can be used to quickly find distances between transcripts, like-transcript groups, etc.


## Installation

To install:
```
git clone https://github.com/yfan2012/castor.git
cd castor
pip install .
```


## Indexing

This is a required step for most/all downstream castor tools. This will generate an index of the tabular transcript data exported from the 'flat file' export module within AtoMx. Note that the transcript file is assumed to be decompressed, and sorted by FOV. As of AtoMx v1.3.2, the tabular transcript table exported with the flat files is pre-sorted by FOV, so no additional sorting will be necessary.

The output of this command will be the index of the input transcript table. This index is a csv file containing data for each FOV, including the fov number, start byte, end byte, and number of cells captured. Currently, transcripts assigned to cells and those that are unassigned are recorded as separate FOVs. Those corresponding to unassigned transcripts will have the suffix `_0` appended to the FOV number.

**Example:**
```
castor index -t example_tx.csv -o example_tx.idx
```

**Arguments:**
- `-t/--txfile` tabular transcript data in csv format
- `-o/--outfile` output index file


## Distance to nearest like-neighbor

This tool calculates the distance of each transcript to the nearest like-transcript. 3D coordinates for each transcript are taken from the tabular transcript file so that each transcript's coordinates in space are defined by the (x_local_px, y_local_px, z) columns.

**Example:**
```
castor txnn -i example_tx.idx -t example_tx.csv -o example_tx_txnn.csv -p 12
```

**Arguments:**
- `-i/--idxfile` index generated (see above)
- `-t/--txfile` tabular transcript data in csv format
- `-o/--outfile` output csv with transcript info, including distance to nearest-like neighbor
- `-p/--threads` number of cores to use (default:12)


## Deduplication
This tool groups like-transcripts based on a specified distance limit (ie, any transcript within the distance limit to any transcript in an established group is added to that group) and reports these groups. Furthermore, new versions of the transcript table and count matrix are written, where only a single transcript from each group is retained. A new count matrix of unassigned transcripts per fov is also written. As with `castor txnn`, each transcript's coordinates is defined by (x_local_px, y_local_px, z). 

**Example:**
```
castor dedup \
  -i example_tx.idx \
  -t example_tx.csv \ 
  -e example_exprMat.csv \
  -d example_tx.deduped.csv \
  -r example_tx.removed.csv \
  -c example_exprMat.deduped.csv \
  -z example_exprMat.unassigned_counts.csv \
  -m 1.9 \
  -p 12
```

**Arguments:**
- `-i/--idxfile` index generated (see above)
- `-t/--txfile` tabular transcript data in csv format
- `-e/--exprMatfile` expression matrix from AtoMx flat file output, decompressed
- `-d/--deduptxfile` output csv file for new transcript table, with a single transcript per group
- `-r/--removedtxfile` output csv file listing transcript groups
- `-c/--countsfile` output csv file with cellxgene count matrix calculated with deduped transcripts
- `-z/--zerocountsfile` output csv file with count matrix for unassigned genes per FOV
- `-m/--maxdist` distance limit for grouping
- `-p/--threads` number of cores to use (default:12)

## Example data
The example data included in the `test` folder is a very small subset of data generated from healthy tonsil tissue provided by Nanostring, as part of their standard training protocol. Specific gene names have been replaced with random strings. The test data includes transcripts from five FOVs, each downsampled to five cells plus all unassigned transcripts.

## Misc
There are other scripts in this repo used for related, but exploratory analysis.

## Acknowledgements
This code was developed against data generated by Alba Font Tello and Diana Wiesnoski in Eugene Drokhlyansky's research group at Bristol Myers Squibb. 

